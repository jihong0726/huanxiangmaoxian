<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¹»æƒ³å†’éšª</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
    }
    .game-container {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 24px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .status-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .status-row div {
      flex: 1;
      text-align: left;
      font-size: 14px;
    }
    .status-row div span {
      font-weight: bold;
    }
    .event-box {
      background: #1f1f1f;
      border-radius: 8px;
      padding: 16px;
      min-height: 120px;
      margin-bottom: 12px;
      line-height: 1.6;
      font-size: 15px;
    }
    .choices {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    button {
      background: #ff9f1c;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      color: #000;
      font-weight: 600;
    }
    button.secondary {
      background: #333;
      color: #fff;
    }
    button.danger {
      background: #e63946;
      color: #fff;
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .inventory-container {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .inventory-box {
      flex: 1 1 30%;
      background: #1f1f1f;
      border-radius: 8px;
      padding: 8px;
      min-height: 80px;
      font-size: 13px;
    }
    .inventory-box h3 {
      margin: 0 0 4px;
      font-size: 14px;
      border-bottom: 1px solid #333;
      padding-bottom: 4px;
    }

    .log {
      background: #000;
      border-radius: 8px;
      padding: 8px;
      font-size: 12px;
      max-height: 180px;
      overflow-y: auto;
      white-space: pre-line;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 2px;
      background: #333;
      color: #ffd166;
    }
    .tag-epic {
      background: linear-gradient(90deg, #a855f7, #ec4899);
      color: #fff;
    }
    .tag-legendary {
      background: linear-gradient(90deg, #f97316, #facc15);
      color: #000;
    }
    .tag-relic {
      background: linear-gradient(90deg, #22d3ee, #a855f7);
      color: #000;
    }
    .divider {
      border-top: 1px solid #333;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="top-bar">
      <h1>âš”ï¸ å¹»æƒ³å†’éšª</h1>
      <div id="achievement-display"></div>
    </div>

    <div class="status-row">
      <div>ç”Ÿå‘½: <span id="stat-hp"></span></div>
      <div>æ”»æ“Š: <span id="stat-atk"></span></div>
      <div>é‡‘å¹£: <span id="stat-gold"></span></div>
      <div>æ·±åº¦: <span id="stat-depth"></span></div>
    </div>

    <div id="buff-display" style="margin-bottom:8px;font-size:13px;"></div>

    <div id="event-display" class="event-box">
      é»æ“Šã€Œé–‹å§‹å†’éšªã€ä¾†å±•é–‹ä½ çš„æ—…ç¨‹ã€‚
    </div>

    <div class="choices" id="choices"></div>

    <div class="inventory-container">
      <div class="inventory-box">
        <h3>æ­¦å™¨</h3>
        <div id="weapon-display">ç„¡</div>
      </div>
      <div class="inventory-box">
        <h3>é˜²å…·</h3>
        <div id="armor-display">ç„¡</div>
      </div>
      <div class="inventory-box">
        <h3>ç›¾ç‰Œ</h3>
        <div id="shield-display">ç„¡</div>
      </div>
    </div>

    <div class="inventory-container">
      <div class="inventory-box">
        <h3>ç¥å™¨ / è£å‚™</h3>
        <div id="inventory-display">ç„¡</div>
      </div>
      <div class="inventory-box">
        <h3>æ¶ˆè€—å“</h3>
        <div id="consumable-display">ç„¡</div>
      </div>
      <div class="inventory-box">
        <h3>ç´ æ</h3>
        <div id="material-display">ç„¡</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="choices" id="main-buttons">
      <button id="start-btn">é–‹å§‹å†’éšª</button>
      <button id="restart-btn" class="secondary">é‡æ–°é–‹å§‹éŠæˆ²</button>
    </div>

    <div class="log" id="log-display"></div>
  </div>

  <script>
    // =========================
    // ä¸€äº›åŸºç¤å¸¸æ•¸èˆ‡å·¥å…·
    // =========================
    const CONFIG = {
      maxDepth: 999,
      baseHp: 100,
      baseAtk: 5,
      baseGold: 100,
      bossInterval: 20
    };

    function rand() {
      return Math.random();
    }
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function choice(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    const Player = {
      maxHp: CONFIG.baseHp,
      hp: CONFIG.baseHp,
      atk: CONFIG.baseAtk,
      gold: CONFIG.baseGold,
      depth: 0,
      weapon: null,
      armor: null,
      shield: null,
      artifacts: [],
      consumables: [],
      materials: [],
      buffs: [],
      state: "idle",
      class: null,
      achievements: new Set(),
      killedBosses: 0
    };

    const GameState = {
      phase: "idle",
      currentEnemy: null
    };

    const Skills = {
      thiefChestSafe: "ç›œè³Šå¤©è³¦ï¼šé–‹å•Ÿå¯¶ç®±æ™‚ä¸æœƒé‡åˆ°é™·é˜±æˆ–ç©ºç®±",
      angelBless: "å¤©ä½¿çš„å‹‡æ°£ï¼šä¸‹ä¸€å±¤å¿…å®šå®‰å…¨"
    };

    // =========================
    // è·æ¥­èˆ‡èµ·å§‹é…ç½®
    // =========================
    const Classes = [
      {
        id: "knight",
        name: "é¨å£«",
        desc: "é–‹å±€è£å‚™ã€Œé¨å£«é•·æ§ã€ï¼Œçˆ†æ“Šå¼·åŒ–ç‚ºã€Œè²«ç©¿ä¸€æ“Šã€ï¼ˆ3å€å‚·å®³ï¼‰",
        apply() {
          Player.weapon = { name: "é¨å£«é•·æ§", atk: 10, rarity: "rare" };
          Player.atk += 5;
          Player.class = "é¨å£«";
        }
      },
      {
        id: "merchant",
        name: "å•†è²©",
        desc: "å‡ºå”®åƒ¹æ ¼ 1.2 å€ï¼Œå•†åº—å¯è³¼è²· 6 é …å•†å“",
        apply() {
          Player.class = "å•†è²©";
        }
      },
      {
        id: "thief",
        name: "ç›œè³Š",
        desc: "é–‹å•Ÿå¯¶ç®±æ™‚ä¸æœƒé‡åˆ°é™·é˜±æˆ–ç©ºç®±",
        apply() {
          Player.class = "ç›œè³Š";
          Player.buffs.push(Skills.thiefChestSafe);
        }
      },
      {
        id: "cultist",
        name: "æƒ¡é­”ä¿¡å¾’",
        desc: "é–‹å±€è‡ªå¸¶ä¸€å€‹æƒ¡é­”è©›å’’",
        apply() {
          Player.class = "æƒ¡é­”ä¿¡å¾’";
          Player.buffs.push("æƒ¡é­”å¥‘ç´„ï¼šHP ä¸Šé™ -20ï¼Œæ”»æ“Š +5");
          Player.maxHp -= 20;
          Player.hp = Player.maxHp;
          Player.atk += 5;
        }
      },
      {
        id: "hermit",
        name: "ç¨»è‰äºº",
        desc: "å¿…å®šæ¨èµ°å“ˆæ¯”ï¼Œç„¡æ³•è£å‚™é‡å‹ç›¾ç‰Œ",
        apply() {
          Player.class = "ç¨»è‰äºº";
        }
      },
      {
        id: "ape",
        name: "äººçŒ¿",
        desc: "é­é‡è·Œå€’äº‹ä»¶å¿…å®šæŠ“ä½å²©å£",
        apply() {
          Player.class = "äººçŒ¿";
        }
      },
      {
        id: "challenger",
        name: "æŒ‘æˆ°è€…",
        desc: "ç„¡ä»»ä½•ç‰¹æ®ŠæŠ€èƒ½ï¼Œé–‹å±€ç²å¾—ä¸€ç“¶ã€Œå¼·åŠ›è—¥æ°´ã€",
        apply() {
          Player.class = "æŒ‘æˆ°è€…";
          Player.consumables.push({
            name: "å¼·åŠ›è—¥æ°´",
            type: "potion",
            effect: "heal50",
            desc: "ç«‹å³æ¢å¾© 50 HP"
          });
        }
      }
    ];

    const Relics = [
      {
        id: "sunlight",
        name: "ğŸŒ ç¥ä¹‹å…‰è¼",
        rarity: "relic",
        desc: "æ”»æ“Š +10ï¼Œæˆ°é¬¥çµæŸå¾Œé¡å¤–å›å¾© 10 HPï¼Œç„¡æ³•é‡è¤‡ç²å¾—",
        once: true,
        apply() {
          Player.atk += 10;
          Player.buffs.push("ç¥ä¹‹å…‰è¼ï¼šæ¯å ´æˆ°é¬¥å¾Œæ¢å¾© 10 HP");
        }
      },
      {
        id: "abyssHeart",
        name: "ğŸ’œ æ·±æ·µä¹‹å¿ƒ",
        rarity: "relic",
        desc: "æœ€å¤§ç”Ÿå‘½ +50ï¼Œæ·±åº¦æ¯ 10 å±¤é¡å¤– +5 æ”»æ“Š",
        once: true,
        apply() {
          Player.maxHp += 50;
          Player.hp += 50;
          Player.buffs.push("æ·±æ·µä¹‹å¿ƒï¼šæ¯ 10 å±¤ +5 æ”»æ“Š");
        }
      }
    ];

    const Artifacts = [
      {
        id: "luckyCoin",
        name: "ğŸ€ å¹¸é‹é‡‘å¹£",
        rarity: "epic",
        desc: "å¯¶ç®±ä¸­ç²å¾—é‡‘å¹£é‡æå‡",
        apply() {
          Player.buffs.push("å¹¸é‹é‡‘å¹£ï¼šå¯¶ç®±é‡‘å¹£æå‡");
        }
      },
      {
        id: "bloodRing",
        name: "ğŸ’ å¸è¡€æˆ’æŒ‡",
        rarity: "epic",
        desc: "æˆ°é¬¥é€ æˆå‚·å®³çš„ 10% è½‰ç‚ºè‡ªèº« HP",
        apply() {
          Player.buffs.push("å¸è¡€æˆ’æŒ‡ï¼šé€ æˆå‚·å®³çš„ 10% è½‰ç‚º HP");
        }
      }
    ];

    const GoldenChestTable = [
      { type: "relic", weight: 3 },
      { type: "artifact", weight: 5 },
      { type: "gearEpic", weight: 4 },
      { type: "gearRare", weight: 4 }
    ];

    function weightedChoice(table) {
      const total = table.reduce((s, x) => s + x.weight, 0);
      let r = Math.random() * total;
      for (const item of table) {
        if (r < item.weight) return item;
        r -= item.weight;
      }
      return table[table.length - 1];
    }

    // =========================
    // UI æ›´æ–°
    // =========================
    function log(msg) {
      const logEl = document.getElementById("log-display");
      if (!logEl) return;
      const t = `[æ·±åº¦ ${Player.depth} å±¤] ${msg}`;
      logEl.textContent = t + "\n" + logEl.textContent;
    }

    function renderBuffs() {
      const buffEl = document.getElementById("buff-display");
      if (!buffEl) return;
      if (!Player.buffs.length) {
        buffEl.textContent = "ç‹€æ…‹ï¼šç„¡";
        return;
      }
      buffEl.textContent = "ç‹€æ…‹ï¼š" + Player.buffs.join("ã€");
    }

    function renderAchievements() {
      const achEl = document.getElementById("achievement-display");
      if (!achEl) return;
      if (!Player.achievements.size) {
        achEl.innerHTML = "";
        return;
      }
      const parts = [];
      Player.achievements.forEach(a => parts.push(`<span class="tag">${a}</span>`));
      achEl.innerHTML = parts.join(" ");
    }

    function formatRarityTag(rarity) {
      if (rarity === "legendary") return '<span class="tag tag-legendary">å‚³èªª</span>';
      if (rarity === "relic") return '<span class="tag tag-relic">ç¥å™¨</span>';
      if (rarity === "epic") return '<span class="tag tag-epic">å²è©©</span>';
      if (rarity === "rare") return '<span class="tag">ç¨€æœ‰</span>';
      return '<span class="tag">æ™®é€š</span>';
    }

    function updateUI(text) {
      if (text) {
        document.getElementById("event-display").innerHTML = text;
      }
      // é€™è£¡ä»¥å‰æœƒç›´æ¥å¯« stats-displayï¼Œç¾åœ¨æ”¹æˆã€Œæœ‰å°±å¯«ï¼Œæ²’æœ‰å°±ç•¥éã€
      const statsElement = document.getElementById("stats-display");
      if (statsElement) {
        statsElement.innerHTML = `
          â¤ï¸ HP: ${Player.hp}/${Player.maxHp}<br>
          âš”ï¸ æ”»æ“ŠåŠ›: ${Player.atk}<br>
          ğŸ’° é‡‘å¹£: ${Player.gold}<br>
          ğŸ” æ·±åº¦: ${Player.depth} å±¤
        `;
      }

      document.getElementById("inventory-display").innerHTML =
        Player.artifacts.length || Player.weapon || Player.armor || Player.shield
          ? [
              Player.weapon ? `${formatRarityTag(Player.weapon.rarity || "common")} æ­¦å™¨ï¼š${Player.weapon.name} (+${Player.weapon.atk})` : "",
              Player.armor ? `${formatRarityTag(Player.armor.rarity || "common")} é˜²å…·ï¼š${Player.armor.name}` : "",
              Player.shield ? `${formatRarityTag(Player.shield.rarity || "common")} ç›¾ç‰Œï¼š${Player.shield.name}` : "",
              Player.artifacts.length
                ? "ç¥å™¨ / ç‰¹æ®Šè£å‚™ï¼š" +
                  Player.artifacts
                    .map(a => `${formatRarityTag(a.rarity || "epic")} ${a.name}`)
                    .join("ã€")
                : ""
            ]
              .filter(Boolean)
              .join("<br>")
          : "ç„¡";

      document.getElementById("consumable-display").innerHTML =
        Player.consumables.length
          ? Player.consumables.map(c => c.name).join("ã€")
          : "ç„¡";

      document.getElementById("material-display").innerHTML =
        Player.materials.length
          ? Player.materials.map(m => `${m.name} x${m.count || 1}`).join("ã€")
          : "ç„¡";

      document.getElementById("weapon-display").innerHTML =
        Player.weapon
          ? `${formatRarityTag(Player.weapon.rarity || "common")} ${Player.weapon.name} (+${Player.weapon.atk})`
          : "ç„¡æ­¦å™¨";

      document.getElementById("armor-display").innerHTML =
        Player.armor
          ? `${formatRarityTag(Player.armor.rarity || "common")} ${Player.armor.name}`
          : "ç„¡é˜²å…·";

      document.getElementById("shield-display").innerHTML =
        Player.shield
          ? `${formatRarityTag(Player.shield.rarity || "common")} ${Player.shield.name}`
          : "ç„¡ç›¾ç‰Œ";

      const hpDisplay = document.getElementById("stat-hp");
      if (hpDisplay) hpDisplay.textContent = `${Player.hp} / ${Player.maxHp}`;
      const atkDisplay = document.getElementById("stat-atk");
      if (atkDisplay) atkDisplay.textContent = Player.atk;
      const goldDisplay = document.getElementById("stat-gold");
      if (goldDisplay) goldDisplay.textContent = Player.gold;
      const depthDisplay = document.getElementById("stat-depth");
      if (depthDisplay) depthDisplay.textContent = Player.depth;

      renderBuffs();
      renderAchievements();
    }

    function setChoices(buttons) {
      const container = document.getElementById("choices");
      container.innerHTML = "";
      buttons.forEach(b => {
        const btn = document.createElement("button");
        btn.textContent = b.label;
        if (b.className) btn.className = b.className;
        btn.onclick = () => b.onClick();
        container.appendChild(btn);
      });
    }

    // =========================
    // æˆ°é¬¥èˆ‡äº‹ä»¶
    // =========================
    function createEnemy(isBoss = false) {
      if (isBoss) {
        return {
          name: `ç¬¬ ${Player.depth} å±¤å®ˆé–€è€… éª¸é«å…µ`,
          hp: 50 + Player.depth * 2,
          atk: 10 + Math.floor(Player.depth / 2),
          boss: true
        };
      }
      const baseHp = 20 + Player.depth * 2;
      const baseAtk = 5 + Math.floor(Player.depth / 3);
      return {
        name: "éª¸é«å…µ",
        hp: baseHp,
        atk: baseAtk,
        boss: false
      };
    }

    function applyPostBattleHealing(damageDealt) {
      if (Player.buffs.some(b => b.includes("å¸è¡€æˆ’æŒ‡"))) {
        const heal = Math.floor(damageDealt * 0.1);
        if (heal > 0) {
          Player.hp = Math.min(Player.maxHp, Player.hp + heal);
          log(`å¸è¡€æˆ’æŒ‡ç™¼å‹•ï¼Œå›å¾© ${heal} HPã€‚`);
        }
      }
      if (Player.buffs.some(b => b.includes("ç¥ä¹‹å…‰è¼"))) {
        const heal = 10;
        Player.hp = Math.min(Player.maxHp, Player.hp + heal);
        log(`ç¥ä¹‹å…‰è¼ç…§è€€ï¼Œæˆ°é¬¥å¾Œé¡å¤–å›å¾© ${heal} HPã€‚`);
      }
    }

    function battle(enemy) {
      GameState.currentEnemy = enemy;
      Player.state = "battle";
      log(`èˆ‡ã€Œ${enemy.name}ã€å±•é–‹æˆ°é¬¥ï¼ï¼ˆHP: ${enemy.hp}, æ”»æ“Š: ${enemy.atk}ï¼‰`);

      const playerDamage = Math.max(1, Player.atk + randInt(0, 4));
      const enemyDamage = Math.max(1, enemy.atk + randInt(0, 3));

      enemy.hp -= playerDamage;
      Player.hp -= enemyDamage;

      applyPostBattleHealing(playerDamage);

      if (Player.hp <= 0) {
        Player.hp = 0;
        updateUI(`ä½ å° ${enemy.name} é€ æˆ ${playerDamage} å‚·å®³ï¼Œä½†ä¹Ÿæ‰¿å—äº† ${enemyDamage} å‚·å®³ã€‚<br><br>ä½ å€’ä¸‹äº†â€¦â€¦ å†’éšªåœ¨æ­¤çµæŸã€‚`);
        setChoices([
          { label: "é‡æ–°é–‹å§‹", onClick: () => restartGame(), className: "danger" }
        ]);
        log("ä½ åœ¨æˆ°é¬¥ä¸­é™£äº¡ã€‚");
        return;
      }

      if (enemy.hp <= 0) {
        const goldGain = enemy.boss ? 80 + Player.depth * 3 : 30 + Player.depth * 2;
        Player.gold += goldGain;
        if (enemy.boss) Player.killedBosses++;

        let bossTag = enemy.boss ? "ï¼ˆBoss æ’ƒç ´ï¼ï¼‰" : "";
        updateUI(`ä½ å° ${enemy.name} é€ æˆ ${playerDamage} å‚·å®³ï¼Œæ‰¿å— ${enemyDamage} å‚·å®³ï¼Œæœ€çµ‚æˆåŠŸæ“Šæ•—äº† ${enemy.name}${bossTag}ï¼<br><br>ç²å¾— ${goldGain} é‡‘å¹£ã€‚`);
        log(`æ“Šæ•— ${enemy.name}${bossTag}ï¼Œç²å¾— ${goldGain} é‡‘å¹£ã€‚`);

        if (enemy.boss) {
          Player.achievements.add(`æ“Šæ•—ç¬¬ ${Player.depth} å±¤å®ˆé–€è€…`);
          updateUI(`ğŸ‰ ä½ æ“Šæ•—äº†ç¬¬ ${Player.depth} å±¤çš„å®ˆé–€è€…ï¼<br>å†’éšªæš«æ™‚å‘Šä¸€æ®µè½ï¼Œä½†æ·±æ·µä»åœ¨å‘¼å–šä½ â€¦â€¦`);
          setChoices([
            { label: "ç¹¼çºŒæ·±å…¥", onClick: () => nextEvent() },
            { label: "å°±æ­¤æ‰“ä½ï¼ˆé‡æ–°é–‹å§‹ï¼‰", onClick: () => restartGame(), className: "secondary" }
          ]);
        } else {
          setChoices([
            { label: "ç¹¼çºŒå‰é€²", onClick: () => nextEvent() }
          ]);
        }

        updateUI();
        return;
      }

      updateUI(`ä½ å° ${enemy.name} é€ æˆ ${playerDamage} å‚·å®³ï¼Œæ‰¿å— ${enemyDamage} å‚·å®³ã€‚<br><br>é›™æ–¹ä»åœ¨æ¿€æˆ°ä¸­ï¼`);
      setChoices([
        { label: "ç¹¼çºŒæˆ°é¬¥", onClick: () => battle(enemy) },
        { label: "å˜—è©¦é€ƒè·‘", onClick: () => tryEscape(enemy), className: "secondary" }
      ]);
    }

    function tryEscape(enemy) {
      if (enemy.boss && Player.depth % CONFIG.bossInterval === 0) {
        updateUI(`ä½ å˜—è©¦å¾å®ˆé–€è€…é¢å‰é€ƒè·‘â€¦â€¦ ä½†åœ¨æœ€çµ‚æ±ºæˆ°ä¸­ï¼Œä½ é¼“èµ·æ‰€æœ‰å‹‡æ°£ï¼Œæ±ºå®šæ­£é¢è¿æˆ°ï¼`);
        setChoices([
          { label: "åˆ¥é€ƒäº†ï¼Œæ±ºä¸€æ­»æˆ°ï¼", onClick: () => battle(enemy), className: "danger" }
        ]);
        return;
      }
      updateUI("ä½ æˆåŠŸè„«é›¢æˆ°é¬¥ï¼Œæ‚„æ‚„æ’¤é€€åˆ°ä¸Šä¸€æ¢å®‰å…¨é€šé“ã€‚");
      log("ä½ æˆåŠŸé€ƒé›¢äº†æˆ°é¬¥ã€‚");
      setChoices([
        { label: "æ•´ç†ä¸€ä¸‹å†å‡ºç™¼", onClick: () => nextEvent() }
      ]);
    }

    // =========================
    // äº‹ä»¶ç³»çµ±
    // =========================
    function triggerChest(golden = false) {
      const isThief = Player.class === "ç›œè³Š";
      if (golden) {
        const hasRelic = id => Player.artifacts.some(a => a.id === id);
        let rewardText = "ä½ æ‰“é–‹äº†é‡‘è‰²å¯¶ç®±ï¼Œè£¡é¢å…‰èŠ’å››å°„ï¼š<br>";

        let rewardType = weightedChoice(GoldenChestTable).type;

        if (hasRelic("sunlight") && hasRelic("abyssHeart")) {
          const nonRelic = GoldenChestTable.filter(t => t.type !== "relic");
          rewardType = weightedChoice(nonRelic).type;
        } else if (hasRelic("sunlight")) {
          rewardType = rand() < 0.5 ? "relic" : rewardType;
        } else if (hasRelic("abyssHeart")) {
          rewardType = rand() < 0.5 ? "relic" : rewardType;
        } else {
          rewardType = "relic";
        }

        if (rewardType === "relic") {
          const availRelics = Relics.filter(r => !Player.artifacts.some(a => a.id === r.id));
          const relic = choice(availRelics.length ? availRelics : Relics);
          Player.artifacts.push(relic);
          relic.apply();
          rewardText += `${formatRarityTag("relic")} ä½ ç²å¾—äº†ç¥å™¨ã€Œ${relic.name}ã€ï¼<br>${relic.desc}`;
          log(`ç²å¾—ç¥å™¨ï¼š${relic.name}`);
        } else if (rewardType === "artifact") {
          const artifact = choice(Artifacts);
          Player.artifacts.push(artifact);
          artifact.apply();
          rewardText += `${formatRarityTag("epic")} ä½ ç²å¾—äº†è£å‚™ã€Œ${artifact.name}ã€ï¼<br>${artifact.desc}`;
          log(`ç²å¾—å²è©©è£å‚™ï¼š${artifact.name}`);
        } else if (rewardType === "gearEpic") {
          const gearType = choice(["weapon", "armor", "shield"]);
          const name = gearType === "weapon" ? "ç†¾ç„°å¤§åŠ" : gearType === "armor" ? "é¾é±—é§ç”²" : "è–ç›¾";
          const atkBonus = gearType === "weapon" ? 15 : 0;
          const defWord = gearType === "weapon" ? "æ”»æ“Š" : "é˜²ç¦¦";
          if (gearType === "weapon") Player.weapon = { name, atk: atkBonus, rarity: "epic" };
          else if (gearType === "armor") Player.armor = { name, rarity: "epic" };
          else Player.shield = { name, rarity: "epic" };
          if (gearType === "weapon") Player.atk += atkBonus;
          rewardText += `${formatRarityTag("epic")} ä½ ç²å¾—äº†ã€Œ${name}ã€ï¼Œ${defWord}èƒ½åŠ›å¤§å¹…æå‡ï¼`;
          log(`ç²å¾—å²è©©ç´šè£å‚™ï¼š${name}`);
        } else if (rewardType === "gearRare") {
          const gearType = choice(["weapon", "armor", "shield"]);
          const name = gearType === "weapon" ? "ç²¾é‹¼é•·åŠ" : gearType === "armor" ? "å …å›ºé§ç”²" : "é‹¼éµåœ“ç›¾";
          const atkBonus = gearType === "weapon" ? 8 : 0;
          if (gearType === "weapon") Player.weapon = { name, atk: atkBonus, rarity: "rare" };
          else if (gearType === "armor") Player.armor = { name, rarity: "rare" };
          else Player.shield = { name, rarity: "rare" };
          if (gearType === "weapon") Player.atk += atkBonus;
          rewardText += `${formatRarityTag("rare")} ä½ ç²å¾—äº†ã€Œ${name}ã€ï¼Œå¯¦ç”¨å¯é çš„è£å‚™ã€‚`;
          log(`ç²å¾—ç¨€æœ‰è£å‚™ï¼š${name}`);
        }

        updateUI(rewardText);
        setChoices([{ label: "æ”¶å¥½æˆ°åˆ©å“ï¼Œç¹¼çºŒå‰é€²", onClick: () => nextEvent() }]);
        return;
      }

      if (!isThief && rand() < 0.25) {
        const trapDmg = 20 + randInt(0, 10);
        Player.hp = Math.max(0, Player.hp - trapDmg);
        updateUI(`ä½ å°å¿ƒç¿¼ç¿¼åœ°æ‰“é–‹å¯¶ç®±ï¼Œçµæœâ€”â€”<br><br>ğŸ’£ å¼·åŠ›çš„é­”æ³•ç‚¸å½ˆé£›äº†å‡ºä¾†ï¼ä½ å—åˆ° ${trapDmg} å‚·å®³ã€‚`);
        log(`é–‹å•Ÿå¯¶ç®±è§¸ç™¼é™·é˜±ï¼Œå—åˆ° ${trapDmg} å‚·å®³ã€‚`);
        if (Player.hp <= 0) {
          updateUI(`ä½ è¢«ç‚¸å¾—éé«”é±—å‚·ï¼Œçœ¼å‰ä¸€é»‘â€¦â€¦ å†’éšªåœ¨æ­¤çµ‚çµã€‚`);
          setChoices([{ label: "é‡æ–°é–‹å§‹", onClick: () => restartGame(), className: "danger" }]);
        } else {
          setChoices([{ label: "ç—›åˆ°æ‡·ç–‘äººç”Ÿï¼Œä½†é‚„æ˜¯è¦èµ°", onClick: () => nextEvent() }]);
        }
        return;
      }

      const goldGain = 50 + randInt(0, 50);
      Player.gold += goldGain;
      const maybePotion = rand() < 0.4;
      let text = `ä½ æ‰“é–‹å¯¶ç®±ï¼Œè£¡é¢æœ‰ä¸€å †é‡‘å¹£ï¼<br>ç²å¾— ${goldGain} é‡‘å¹£ã€‚`;
      log(`é–‹å•Ÿå¯¶ç®±ï¼Œç²å¾— ${goldGain} é‡‘å¹£ã€‚`);
      if (maybePotion) {
        const potion = {
          name: "æ²»ç™‚è—¥æ°´",
          type: "potion",
          effect: "heal30",
          desc: "å›å¾© 30 HP"
        };
        Player.consumables.push(potion);
        text += `<br>å¦å¤–ï¼Œä½ é‚„æ‰¾åˆ°äº†ä¸€ç“¶ã€Œæ²»ç™‚è—¥æ°´ã€ã€‚`;
        log("ç²å¾—æ¶ˆè€—å“ï¼šæ²»ç™‚è—¥æ°´ã€‚");
      }
      updateUI(text);
      setChoices([{ label: "æ”¶å¥½æˆ°åˆ©å“ï¼Œç¹¼çºŒå‰é€²", onClick: () => nextEvent() }]);
    }

    function triggerShop() {
      const baseItems = [
        {
          type: "potion",
          item: { name: "æ²»ç™‚è—¥æ°´", price: 30, effect: "heal30", desc: "å›å¾© 30 HP" }
        },
        {
          type: "potion",
          item: { name: "å¼·åŠ›è—¥æ°´", price: 60, effect: "heal60", desc: "å›å¾© 60 HP" }
        },
        {
          type: "gear",
          item: { name: "é‹¼éµé•·åŠ", atk: 8, price: 80, rarity: "rare" }
        },
        {
          type: "gear",
          item: { name: "ç²¾ç·»é§ç”²", price: 70, rarity: "rare" }
        }
      ];

      const merchantBonus = Player.class === "å•†è²©" ? 6 : 4;
      const items = [];
      for (let i = 0; i < merchantBonus; i++) {
        items.push(choice(baseItems));
      }

      let html = "ä½ é‡åˆ°äº†ä¸€ä½ç¥ç§˜çš„é»‘å¸‚å•†äººï¼Œä»–æ”¤é–‹è²¨ç‰©å°ä½ å¾®ç¬‘ï¼š<br><br>";
      items.forEach((entry, idx) => {
        const item = entry.item;
        const price = Math.floor(
          item.price * (Player.class === "å•†è²©" ? 0.8 : 1)
        );
        if (entry.type === "potion") {
          html += `${idx + 1}. ${item.name} - åƒ¹æ ¼ ${price} é‡‘å¹£ï¼ˆ${item.desc}ï¼‰<br>`;
        } else if (entry.type === "gear") {
          html += `${idx + 1}. ${item.name} - åƒ¹æ ¼ ${price} é‡‘å¹£ ${item.atk ? `ï¼ˆæ”»æ“Š +${item.atk}ï¼‰` : ""}<br>`;
        }
      });
      html += `<br>ä½ ç›®å‰æœ‰ ${Player.gold} é‡‘å¹£ã€‚`;

      updateUI(html);

      const buttons = items.map((entry, idx) => {
        return {
          label: `è³¼è²·ç¬¬ ${idx + 1} é …`,
          onClick: () => {
            const item = entry.item;
            const price = Math.floor(
              item.price * (Player.class === "å•†è²©" ? 0.8 : 1)
            );
            if (Player.gold < price) {
              updateUI("ä½ çš„éŒ¢åŒ…ç™¼å‡ºå¾®å¼±çš„æ‚²é³´ï¼šé‡‘å¹£ä¸è¶³ï¼Œç„¡æ³•è³¼è²·ã€‚");
              setChoices([
                { label: "çœ‹çœ‹åˆ¥çš„æ±è¥¿", onClick: () => triggerShop() },
                { label: "é›¢é–‹å•†åº—", onClick: () => nextEvent(), className: "secondary" }
              ]);
              return;
            }
            Player.gold -= price;
            if (entry.type === "potion") {
              Player.consumables.push({
                name: item.name,
                type: "potion",
                effect: item.effect,
                desc: item.desc
              });
              log(`è³¼è²·äº† ${item.name}ã€‚`);
              updateUI(`ä½ è³¼è²·äº†ã€Œ${item.name}ã€ï¼Œå°å¿ƒç¿¼ç¿¼åœ°æ”¶é€²èƒŒåŒ…ã€‚`);
            } else if (entry.type === "gear") {
              if (item.atk) {
                Player.weapon = {
                  name: item.name,
                  atk: item.atk,
                  rarity: item.rarity || "rare"
                };
                Player.atk += item.atk;
                log(`è³¼è²·æ­¦å™¨ï¼š${item.name}ã€‚`);
                updateUI(`ä½ è³¼è²·ä¸¦è£å‚™äº†ã€Œ${item.name}ã€ï¼Œæ„Ÿè¦ºæ‰‹ä¸­çš„åŠ›é‡æ›´ç©©å›ºäº†ã€‚`);
              } else {
                Player.armor = {
                  name: item.name,
                  rarity: item.rarity || "rare"
                };
                log(`è³¼è²·é˜²å…·ï¼š${item.name}ã€‚`);
                updateUI(`ä½ è³¼è²·ä¸¦æ›ä¸Šäº†ã€Œ${item.name}ã€ï¼Œæ„Ÿè¦ºèº«ä¸Šçš„é˜²è­·æ›´åŠ å¯é ã€‚`);
              }
            }
            updateUI();
            setChoices([
              { label: "å†é€›é€›", onClick: () => triggerShop() },
              { label: "é›¢é–‹å•†åº—", onClick: () => nextEvent(), className: "secondary" }
            ]);
          }
        };
      });

      buttons.push({
        label: "é›¢é–‹å•†åº—",
        className: "secondary",
        onClick: () => {
          updateUI("ä½ å’Œå•†äººæ®æ‰‹é“åˆ¥ï¼Œç¹¼çºŒè¸ä¸Šæ—…ç¨‹ã€‚");
          nextEvent();
        }
      });

      setChoices(buttons);
    }

    function triggerRest() {
      if (Player.hp >= Player.maxHp * 0.8) {
        updateUI("ä½ æ‰¾åˆ°ä¸€è™•å®‰å…¨çš„å°æˆ¿é–“ï¼Œæœ¬ä¾†æƒ³ä¼‘æ¯ä¸€ä¸‹ï¼Œä½†è¦ºå¾—è‡ªå·±ç‹€æ…‹é‚„ä¸éŒ¯ï¼Œæ±ºå®šç¹¼çºŒå‰é€²ã€‚");
        log("ä½ æ”¾æ£„äº†ä¼‘æ¯æ©Ÿæœƒï¼Œé¸æ“‡ç¹¼çºŒå‰é€²ã€‚");
        setChoices([{ label: "ç¹¼çºŒå†’éšª", onClick: () => nextEvent() }]);
        return;
      }
      const heal = Math.floor(Player.maxHp * 0.4);
      Player.hp = Math.min(Player.maxHp, Player.hp + heal);
      updateUI(`ä½ åœ¨ä¸€è™•æº«æš–çš„ç‡Ÿç«æ—ä¼‘æ¯äº†ä¸€æœƒå…’ï¼Œå›å¾©äº† ${heal} HPã€‚`);
      log(`ä¼‘æ¯æ¢å¾© ${heal} HPã€‚`);
      setChoices([{ label: "ç²¾ç¥é£½æ»¿åœ°å‡ºç™¼", onClick: () => nextEvent() }]);
    }

    function triggerAngel() {
      const text = `ä½ é‡åˆ°ä¸€ä½ç¥ç§˜çš„å¤©ä½¿ï¼Œå¥¹è¼•è¼•æŒ‰ä½ä½ çš„è‚©è†€ï¼š<br><br>ã€Œå­©å­ï¼Œä¸‹ä¸€å±¤å°‡ç”±æˆ‘å®ˆè­·ã€‚ã€<br><br>ä½ ç²å¾—äº†ã€Œå¤©ä½¿çš„å‹‡æ°£ã€ï¼Œä¸‹ä¸€å±¤å¿…å®šä¸æœƒé‡åˆ°æˆ°é¬¥æˆ–é™·é˜±ã€‚`;
      if (!Player.buffs.includes("å¤©ä½¿çš„å‹‡æ°£")) {
        Player.buffs.push("å¤©ä½¿çš„å‹‡æ°£");
      }
      updateUI(text);
      log("ç²å¾—å¤©ä½¿çš„ç¥ç¦ï¼šä¸‹ä¸€å±¤å®‰å…¨ã€‚");
      setChoices([{ label: "å¸¶è‘—å‹‡æ°£å‰é€²", onClick: () => nextEvent() }]);
    }

    function triggerGoldenChest() {
      triggerChest(true);
    }

    // =========================
    // äº‹ä»¶è¼ªç›¤èˆ‡å±¤æ•¸é‚è¼¯
    // =========================
    function getEventTypeForDepth(depth) {
      if (depth > 0 && depth % CONFIG.bossInterval === 0) {
        return "boss";
      }
      const mod = depth % 10;
      switch (mod) {
        case 1: return "combat";
        case 2: return "shop";
        case 3: return "angel";
        case 4: return "golden";
        case 5: return "rest";
        case 6: return "combat";
        case 7: return "shop";
        case 8: return "angel";
        case 9: return "golden";
        case 0: return "rest";
        default: return "combat";
      }
    }

    function nextEvent() {
      if (Player.hp <= 0) {
        updateUI("ä½ å·²ç¶“ç„¡æ³•ç¹¼çºŒå†’éšªäº†â€¦â€¦");
        setChoices([{ label: "é‡æ–°é–‹å§‹", onClick: () => restartGame(), className: "danger" }]);
        return;
      }

      Player.depth++;
      renderAchievements();
      renderBuffs();
      updateUI();

      if (Player.buffs.includes("å¤©ä½¿çš„å‹‡æ°£")) {
        Player.buffs = Player.buffs.filter(b => b !== "å¤©ä½¿çš„å‹‡æ°£");
        updateUI("å¤©ä½¿çš„å‹‡æ°£ç™¼å‹•ï¼Œé€™ä¸€å±¤æ²’æœ‰ä»»ä½•å±éšªï¼Œä½ å®‰ç„¶é€šéã€‚");
        log("åœ¨å¤©ä½¿çš„åŠ è­·ä¸‹ï¼Œä½ è¼•é¬†é€šéäº†ä¸€å±¤ã€‚");
        setChoices([{ label: "ç¹¼çºŒå‰é€²", onClick: () => nextEvent() }]);
        return;
      }

      const eventType = getEventTypeForDepth(Player.depth);

      if (Player.depth % CONFIG.bossInterval === 0) {
        const enemy = createEnemy(true);
        updateUI(`ä½ ä¾†åˆ°äº†ç¬¬ ${Player.depth} å±¤çš„ç›¡é ­ï¼Œä¸€åå¼·å¤§çš„å®ˆé–€è€…æ“‹åœ¨ä½ é¢å‰ï¼š<br><br>ã€Œå‡¡äººï¼Œæƒ³è¦é€šéæ­¤è™•ï¼Œå°±å…ˆæ‰“æ•—æˆ‘ï¼ã€<br><br>HP: ${enemy.hp}ï¼Œæ”»æ“Š: ${enemy.atk}`);
        setChoices([
          { label: "æ±ºä¸€æ­»æˆ°ï¼", onClick: () => battle(enemy), className: "danger" },
          { label: "æš«æ™‚æ’¤é€€ï¼ˆå¿…å®šæˆåŠŸé€ƒè·‘ï¼‰", onClick: () => { updateUI("ä½ é¸æ“‡æš«æ™‚æ’¤é€€ï¼Œæ±ºå®šå…ˆèª¿æ•´ç‹€æ…‹å†ä¾†æŒ‘æˆ°å®ˆé–€è€…ã€‚"); log("ä½ å¾ Boss é¢å‰æš«æ™‚æ’¤é€€ã€‚"); setChoices([{ label: "æ•´ç†å¥½å¿ƒæƒ…å†å‡ºç™¼", onClick: () => nextEvent() }]); }, className: "secondary" }
        ]);
        return;
      }

      switch (eventType) {
        case "combat":
          const enemy = createEnemy(false);
          updateUI(`ä½ é‡åˆ° ${enemy.name}ï¼HP: ${enemy.hp}ï¼Œæ”»æ“Š: ${enemy.atk}ã€‚`);
          setChoices([
            { label: "æˆ°é¬¥", onClick: () => battle(enemy) },
            { label: "é€ƒè·‘", onClick: () => tryEscape(enemy), className: "secondary" }
          ]);
          break;
        case "shop":
          triggerShop();
          break;
        case "angel":
          triggerAngel();
          break;
        case "golden":
          triggerGoldenChest();
          break;
        case "rest":
          triggerRest();
          break;
        default:
          triggerRest();
      }

      updateUI();
    }

    // =========================
    // éŠæˆ²æµç¨‹
    // =========================
    function showClassSelection() {
      const eventEl = document.getElementById("event-display");
      eventEl.innerHTML = `<strong>é¸æ“‡ä½ çš„è·æ¥­</strong><br><br>æ¯å€‹è·æ¥­éƒ½æœ‰ä¸åŒçš„é–‹å±€èˆ‡èƒ½åŠ›ã€‚`;

      const container = document.getElementById("choices");
      container.innerHTML = "";
      Classes.forEach(c => {
        const btn = document.createElement("button");
        btn.className = "secondary";
        btn.style.width = "45%";
        btn.style.marginBottom = "8px";
        btn.innerHTML = `<strong>${c.name}</strong><br><span style="font-size:12px;">${c.desc}</span>`;
        btn.onclick = () => {
          c.apply();
          log(`ä½ é¸æ“‡äº†è·æ¥­ï¼šã€Œ${c.name}ã€ã€‚`);
          updateUI(`ä½ é¸æ“‡äº†ã€Œ${c.name}ã€ã€‚<br><br>æº–å‚™å¥½å¾Œï¼Œé»æ“Šã€Œé–‹å§‹å†’éšªã€æ­£å¼è¸å…¥æ·±æ·µã€‚`);
          setChoices([
            { label: "é–‹å§‹å†’éšª", onClick: () => { Player.depth = 0; nextEvent(); } }
          ]);
          renderBuffs();
          updateUI();
        };
        container.appendChild(btn);
      });
    }

    function restartGame() {
      Player.maxHp = CONFIG.baseHp;
      Player.hp = CONFIG.baseHp;
      Player.atk = CONFIG.baseAtk;
      Player.gold = CONFIG.baseGold;
      Player.depth = 0;
      Player.weapon = null;
      Player.armor = null;
      Player.shield = null;
      Player.artifacts = [];
      Player.consumables = [];
      Player.materials = [];
      Player.buffs = [];
      Player.state = "idle";
      Player.class = null;
      Player.killedBosses = 0;

      const logEl = document.getElementById("log-display");
      if (logEl) logEl.textContent = "";

      updateUI("æ–°çš„å†’éšªå³å°‡é–‹å§‹ï¼Œå…ˆé¸æ“‡ä½ çš„è·æ¥­å§ã€‚");
      showClassSelection();
    }

    window.onload = () => {
      document.getElementById("start-btn").onclick = () => {
        restartGame();
      };
      document.getElementById("restart-btn").onclick = () => {
        restartGame();
      };
      updateUI("é»æ“Šã€Œé–‹å§‹å†’éšªã€ä¾†å±•é–‹ä½ çš„å†’éšªã€‚");
    };
  </script>
</body>
</html>
